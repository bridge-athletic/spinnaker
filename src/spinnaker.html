<!DOCTYPE html><html lang="en"><head><title>src/spinnaker</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="src/spinnaker"><meta name="groc-project-path" content="src/spinnaker.coffee"><meta name="groc-github-url" content="https://github.com/xdissent/spinnaker"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/xdissent/spinnaker/blob/master/src/spinnaker.coffee">src/spinnaker.coffee</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nx">SpinnakerProvider</span>
  <span class="nv">constructor: </span><span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>All available socket.io message verb for subscription.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@subscriptions = </span><span class="p">[</span><span class="s">&#39;create&#39;</span><span class="p">,</span> <span class="s">&#39;destroy&#39;</span><span class="p">,</span> <span class="s">&#39;update&#39;</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Default actions from $resource plus subscriptions and <code>update</code>.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@defaultActions =</span>
      <span class="nv">get: method: </span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="nv">subscribe: </span><span class="p">[</span><span class="s">&#39;update&#39;</span><span class="p">]</span>
      <span class="nv">save: method: </span><span class="s">&#39;POST&#39;</span>
      <span class="nv">query:</span>
        <span class="nx">method</span><span class="o">:</span><span class="s">&#39;GET&#39;</span>
        <span class="nv">isArray: </span><span class="kc">true</span>
        <span class="nv">subscribe: </span><span class="p">[</span><span class="s">&#39;create&#39;</span><span class="p">,</span> <span class="s">&#39;destroy&#39;</span><span class="p">,</span> <span class="s">&#39;update&#39;</span><span class="p">]</span>
      <span class="nv">remove: method: </span><span class="s">&#39;DELETE&#39;</span>
      <span class="s">&#39;delete&#39;</span><span class="o">:</span> <span class="nv">method: </span><span class="s">&#39;DELETE&#39;</span>
      <span class="nv">update: method: </span><span class="s">&#39;PUT&#39;</span>

  <span class="nv">setUrl: </span><span class="nf">(@url) -&gt;</span>
  <span class="nv">setMock: </span><span class="nf">(@mock) -&gt;</span>
  <span class="nv">setSubscriptions: </span><span class="nf">(@subscriptions) -&gt;</span>
  <span class="nv">setDefaultActions: </span><span class="nf">(@defaultActions) -&gt;</span>

  <span class="nv">$get: </span><span class="nf">($injector) -&gt;</span>
    <span class="nv">inject = </span><span class="p">[</span><span class="s">&#39;$window&#39;</span><span class="p">,</span> <span class="s">&#39;$rootScope&#39;</span><span class="p">,</span> <span class="s">&#39;$parse&#39;</span><span class="p">,</span> <span class="s">&#39;$q&#39;</span><span class="p">]</span>
    <span class="nx">inject</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;spinnakerMock&#39;</span> <span class="k">if</span> <span class="nx">@mock</span>
    <span class="nx">inject</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@service</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">@</span>
    <span class="nx">$injector</span><span class="p">.</span><span class="nx">invoke</span> <span class="nx">inject</span>

  <span class="nv">service: </span><span class="nf">($window, $rootScope, $parse, $q, spinnakerMock) -&gt;</span>
    <span class="nv">origin = </span><span class="nx">@url</span> <span class="o">?</span> <span class="nx">$window</span><span class="p">.</span><span class="nx">location</span><span class="o">?</span><span class="p">.</span><span class="nx">origin</span> <span class="o">?</span> <span class="s">&#39;http://localhost:1337&#39;</span>
    <span class="nv">socket = </span><span class="nx">spinnakerMock</span> <span class="o">?</span> <span class="nx">$window</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">connect</span> <span class="nx">origin</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fake $http service hijacks $resource requests and send them over socket.io.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">$http = </span><span class="nf">(httpConfig) -&gt;</span>
      <span class="nv">deferred = </span><span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>
      <span class="nv">url = </span><span class="nx">httpConfig</span><span class="o">?</span><span class="p">.</span><span class="nx">url</span> <span class="o">?</span> <span class="s">&#39;/&#39;</span>
      <span class="nv">data = </span><span class="nx">httpConfig</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span> <span class="o">?</span> <span class="kc">null</span>
      <span class="nv">options = success: </span><span class="nf">(data) -&gt;</span> <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$apply</span> <span class="nf">-&gt;</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span> <span class="nv">data: </span><span class="nx">data</span>
      <span class="nv">method = </span><span class="nx">httpConfig</span><span class="o">?</span><span class="p">.</span><span class="nx">method</span><span class="o">?</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#39;get&#39;</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">request</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">method</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Build a $resource factory using the fake $http service.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">$resource = </span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s">&#39;ngResource&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">_invokeQueue</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;1&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="nx">$http</span><span class="p">,</span> <span class="nx">$parse</span><span class="p">,</span> <span class="nx">$q</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>$resource factory wrapper to add resource interceptors.</p></div></div><div class="code"><div class="wrapper">    <span class="nf">(name, url=&quot;/#{name}/:id&quot;, paramDefaults={id: &#39;@id&#39;}, actions) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The resource class, created by calling $resource() later.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">Resource = </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add custom actions from arguments.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">actions = </span><span class="nx">angular</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">@defaultActions</span><span class="p">,</span> <span class="nx">actions</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Resource response interceptor to subscribe to updates from Sails.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">interceptor = </span><span class="nf">(actionName, action) =&gt;</span> <span class="nv">response: </span><span class="nf">(response) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Bail unless there are subscriptions.</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">resource</span> <span class="k">unless</span> <span class="nx">action</span><span class="p">.</span><span class="nx">subscribe</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Subscribe to a single subscription, an array, or a function.</p></div></div><div class="code"><div class="wrapper">        <span class="nv">subs = </span><span class="k">if</span> <span class="nx">action</span><span class="p">.</span><span class="nx">subscribe</span> <span class="k">in</span> <span class="nx">@subscriptions</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>It's a string, push it into an array.</p></div></div><div class="code"><div class="wrapper">          <span class="p">[].</span><span class="nx">concat</span> <span class="nx">action</span><span class="p">.</span><span class="nx">subscribe</span> 
        <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>It's an array or function.</p></div></div><div class="code"><div class="wrapper">          <span class="nx">action</span><span class="p">.</span><span class="nx">subscribe</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Listen for messages and fire off subscriptions.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;message&#39;</span><span class="p">,</span> <span class="nf">(msg) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Call function subscription with raw message and bail.</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">subs</span> <span class="nx">response</span><span class="p">.</span><span class="nx">resource</span><span class="p">,</span> <span class="nx">msg</span> <span class="k">if</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">subs</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Bail if the msg isn't for us.</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="kc">null</span> <span class="k">unless</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">model</span> <span class="o">is</span> <span class="nx">name</span> <span class="o">and</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">verb</span> <span class="k">in</span> <span class="nx">subs</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A callback to apply within the $rootScope.</p></div></div><div class="code"><div class="wrapper">          <span class="nv">cb = </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Collection actions</p></div></div><div class="code"><div class="wrapper">          <span class="k">if</span> <span class="nx">action</span><span class="p">.</span><span class="nx">isArray</span>
            <span class="nv">cb = </span><span class="k">switch</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">verb</span>
              <span class="k">when</span> <span class="s">&#39;create&#39;</span> <span class="k">then</span> <span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add a new resource to the collection.</p></div></div><div class="code"><div class="wrapper">                <span class="nx">response</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Resource</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">data</span>
              <span class="k">when</span> <span class="s">&#39;destroy&#39;</span> <span class="k">then</span> <span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remove the destroyed resources from the collection.</p></div></div><div class="code"><div class="wrapper">                <span class="nv">rem = </span><span class="p">[]</span>
                <span class="nx">rem</span><span class="p">.</span><span class="nx">push</span> <span class="nx">i</span> <span class="k">for</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">response</span><span class="p">.</span><span class="nx">resource</span> <span class="k">when</span> <span class="nx">r</span><span class="p">.</span><span class="nx">id</span> <span class="o">is</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span>
                <span class="nx">response</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">splice</span> <span class="nx">i</span><span class="p">,</span> <span class="mi">1</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">rem</span>
              <span class="k">when</span> <span class="s">&#39;update&#39;</span> <span class="k">then</span> <span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Update the resources in the collection.</p></div></div><div class="code"><div class="wrapper">                <span class="nx">angular</span><span class="p">.</span><span class="nx">copy</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">r</span> <span class="k">for</span> <span class="nx">r</span> <span class="k">in</span> <span class="nx">response</span><span class="p">.</span><span class="nx">resource</span> <span class="k">when</span> <span class="nx">r</span><span class="p">.</span><span class="nx">id</span> <span class="o">is</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Instance actions</p></div></div><div class="code"><div class="wrapper">          <span class="k">else</span>
            <span class="nv">cb = </span><span class="k">switch</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">verb</span>
              <span class="k">when</span> <span class="s">&#39;update&#39;</span> <span class="k">then</span> <span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Update the resource directly.</p></div></div><div class="code"><div class="wrapper">                <span class="nx">angular</span><span class="p">.</span><span class="nx">copy</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">resource</span> <span class="k">if</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span> <span class="o">is</span> <span class="nx">response</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">id</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply the callback within the $rootScope if one was found.</p></div></div><div class="code"><div class="wrapper">          <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$apply</span> <span class="nx">cb</span> <span class="k">if</span> <span class="nx">cb</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Return the resource.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">response</span><span class="p">.</span><span class="nx">resource</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add the interceptor to each action.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">a.interceptor = </span><span class="nx">interceptor</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span> <span class="k">for</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">a</span> <span class="k">of</span> <span class="nx">actions</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create and return the $resource class.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">Resource = </span><span class="nx">$resource</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">paramDefaults</span><span class="p">,</span> <span class="nx">actions</span>

<span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s">&#39;spinnaker&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;ngResource&#39;</span><span class="p">])</span>
  <span class="p">.</span><span class="nx">provider</span> <span class="s">&#39;spinnaker&#39;</span><span class="p">,</span> <span class="nx">SpinnakerProvider</span></div></div></div></div></body></html>